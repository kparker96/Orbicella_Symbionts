---
title: "Orb_EX_AB_sym_analysis"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(devtools)   # install.packages("devtools")
library(steponeR) # install_github("jrcunning/steponeR")
library(tidyverse) # (install.packages("tidyverse")
```

# Data Key
# AB  <- Parker_Abaco_2019
# EX  <- Unpublished_Exumas
# KEY <- Manzello_Florida_Keys_2019
# MIA <- Karp_Miami_Unpublished
# CUR <- Green_Curaco_2014 

#Importing Raw Exumas qPCR Data from Quant Studio Design and Analysis Software 
```{r}
# List Exuma symbiodinium data files
plates_EX <- list.files(path = "Data/Unpublished_Exumas", pattern = ".txt", full.names = TRUE)

# Read in data and calculate target ratios
df_EX <- steponeR(files = plates_EX,
               delim = "\t", 
               target.ratios = "A.A", 
               fluor.norm = list(C = 2.234, D = 1, A = 1, B = 1),
               copy.number = list(C = 20, D = 3, A = 1, B = 1),
               ploidy = list(C = 1, D = 1, A = 1, B = 1),
               extract = list(C = 0.813, D = 0.813, A = 0.813, B = 0.813))
qpcr_EX <- df_EX$result

```

#Importing Exumas Sample Data and filtering out other species from Exumas raw qPCR data
```{r}
# Import Sample Data 
library(readr)

raw_sample_data_EX <- readxl::read_xlsx("Data/Unpublished_Exumas/sample_data_Exumas.xlsx")

#renaming  colomns of sample data to match qpcr data
sample_data_EX <- raw_sample_data_EX %>%
  select(Sample.Name = sample_id, site, genus, species, depth = colony_depth_m, range)

# Joining sample data with qpcr data and removing NA samples
EX_Ofav <- right_join(sample_data_EX, qpcr_EX, by = "Sample.Name", all = TRUE) %>%
  filter(genus == "orbicella")

qpcr_EX_Ofav <- EX_Ofav %>%
  select(Sample.Name, File.Name, depth, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean, A.CT.sd, B.CT.sd, C.CT.sd,
         D.CT.sd, A.reps, B.reps, C.reps, D.reps, A.A)
```

#Importing Raw Abaco qPCR Data from Quant Studio Design and Analysis Software 
```{r}
plates_AB <- list.files(path = "Data/Parker_Abaco_2019", pattern = ".txt", full.names = TRUE)

# Read in data and calculate target ratios
df_AB <- steponeR(files = plates_AB, 
               delim = "\t", 
               target.ratios = "A.A", 
               fluor.norm = list(C = 2.234, D = 1, Orb = 1, A = 1, B = 1),
               copy.number = list(C = 20, D = 3, Orb = 1, A = 1, B = 1),
               ploidy = list(C = 1, D = 1, Orb = 2, A = 1, B = 1),
               extract = list(C = 0.813, D = 0.813, Orb = 0.982, A = 0.813, B = 0.813))
qpcr_AB <- df_AB$result %>%
  select(Sample.Name, File.Name, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean, A.CT.sd, B.CT.sd, C.CT.sd,
         D.CT.sd, A.reps, B.reps, C.reps, D.reps, A.A)
```

#Import Abaco Depth Data and add to Abaco qpcr data
```{r}
#library(readr)
sample_data_AB <- readxl::read_xlsx("Data/Parker_Abaco_2019/sample_data_Abaco.xlsx") %>%
  select(Sample.Name = tube_label, depth = colony_depth_m)

qpcr_AB_Ofav <- right_join(sample_data_AB, qpcr_AB, by = "Sample.Name", all = TRUE)

```

#Combine Exumas and Abaco
```{r}
Ofav_qpcr <- rbind(qpcr_EX_Ofav, qpcr_AB_Ofav)
```

# Establishing Ratios for Exumas and Abaco Data
```{r}
# adjust CT for flouresence 
qpcr_flor <- Ofav_qpcr %>%
  mutate(A.CT.mean = A.CT.mean - 1,
         B.CT.mean = B.CT.mean - 1,
         C.CT.mean = C.CT.mean - 1,
         D.CT.mean = D.CT.mean - 1)

# adjust CT to form ratio of Symbiont divided by Copy # (Currently a Placeholder #)
qpcr_copy_num <- qpcr_flor %>%
  mutate(N = 15) %>%
  mutate(A.N = 2^(N - A.CT.mean)/1,
         B.N = 2^(N - B.CT.mean)/1,
         C.N = 2^(N - C.CT.mean)/1,
         D.N = 2^(N - D.CT.mean)/1)

qpcr_prop <- qpcr_copy_num %>%
  mutate(A.N = ifelse(is.na(A.N), 0, A.N),
         B.N = ifelse(is.na(B.N), 0, B.N),
         C.N = ifelse(is.na(C.N), 0, C.N),
         D.N = ifelse(is.na(D.N), 0, D.N)) %>%
  rowwise() %>%
  mutate(total = sum(A.N + B.N + C.N + D.N))%>%
  mutate(A.prop = A.N/total, B.prop = B.N/total, C.prop = C.N/total, D.prop = D.N/total)
   
```

# Organizing Exumas/Abaco qPCR Data
```{r}
# Convert NaN CT values to 0  
qpcr <- qpcr_prop %>%
 mutate(A.CT.mean = ifelse(is.na(A.CT.mean), 0, A.CT.mean),
         B.CT.mean = ifelse(is.na(B.CT.mean), 0, B.CT.mean),
         C.CT.mean = ifelse(is.na(C.CT.mean), 0, C.CT.mean),
         D.CT.mean = ifelse(is.na(D.CT.mean), 0, D.CT.mean))

# Samples that did not amplify for any symbionts
fails <- qpcr %>%
  filter(A.CT.mean == 0 & B.CT.mean == 0 & C.CT.mean == 0 & D.CT.mean == 0) 

# Samples that need to be rerun due to 1 technical replicate or SD > 1
reruns <- qpcr %>%
  filter(Sample.Name != "PTC", Sample.Name != "NTC") %>%
  filter(A.reps == 1 | B.reps == 1 | C.reps == 1 | D.reps == 1 | A.CT.sd > 1.05 | B.CT.sd > 1.05 | C.CT.sd > 1.05 | D.CT.sd > 1.05)

qpcr_data <- qpcr %>%
   filter(A.CT.mean != 0 | B.CT.mean != 0 | C.CT.mean != 0 | D.CT.mean != 0)

  
```

#Filtering out "bad" Exumas/Abaco data/replicates
```{r}
#Determing which samples have 2 replicates in the data set 
dupes <- qpcr_data %>%
  group_by(Sample.Name) %>%
  count(vars = "Sample.Name") %>%
  filter(n > 1) 

#Gathering the full data for samples with 2 replicates
Ofav_dupes <- qpcr_data %>%
  filter(Sample.Name %in% dupes$Sample.Name) %>%
  arrange(Sample.Name)

#filtering out data with only 1 technical replicate
Ofav_dupes_f1 <- Ofav_dupes %>%
  group_by(Sample.Name) %>%
  filter(A.reps != 1, B.reps != 1, C.reps != 1, D.reps != 1) %>%
  ungroup()
  
# Average SD  
Ofav_dupes_f2 <- Ofav_dupes_f1 %>%
  rowwise() %>%
  mutate(avg_sd = mean(c(A.CT.sd, B.CT.sd, C.CT.sd, D.CT.sd), na.rm = TRUE)) %>%
  group_by(Sample.Name) %>%
  dplyr::filter(avg_sd == min(avg_sd)) 

# Raw Data with no replicates
qpcr_good <- qpcr_data %>%
  filter(!(Sample.Name %in% dupes$Sample.Name))


# Cleaned dataset from data that worked the first run and "clean" replicates 
Ofav_good <- qpcr_good %>%
  bind_rows(Ofav_dupes_f2)


need_2_clean <- Ofav_good %>%
  group_by(Sample.Name) %>%
  count(vars = "Sample.Name") %>%
  filter(n > 1) 

# Which Samples Were Duplicated and Still Need to be Rerun?
setdiff(Ofav_dupes$Sample.Name, Ofav_dupes_f2$Sample.Name)
# EX066, Ex0249 won't produce 2 technical replicates for symbionts
# EX0188 failed and do not have rerun data 

setdiff(fails$Sample.Name, Ofav_good$Sample.Name)

# Samples that need to be rerun
setdiff(reruns$Sample.Name, Ofav_dupes_f2$Sample.Name)
```

# Convert Clade to Genera names, Convert NA proportions to 0
```{r}
EXAB_Ofav <- Ofav_good %>%
   mutate(Symbiodinium = case_when(A.prop > 0 ~ A.prop),
         Breviolum = case_when(B.prop > 0 ~ B.prop),
         Cladocopium = case_when(C.prop > 0 ~ C.prop),
         Durusdinium = case_when(D.prop > 0 ~ D.prop)) %>%
   mutate(Symbiodinium = ifelse(is.na(Symbiodinium), 0, Symbiodinium),
          Breviolum = ifelse(is.na(Breviolum), 0, Breviolum),
          Cladocopium = ifelse(is.na(Cladocopium), 0, Cladocopium),
          Durusdinium = ifelse(is.na(Durusdinium), 0, Durusdinium)) %>%
  select(Sample.Name, depth, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

```

#Import Green Curacao 2014 Data 
```{r}
CUR <- readxl::read_xlsx(path = "Data/Green_Curacao_2014/qpcr_green_curacao_data.xlsx") 

CUR_Ofav <- CUR %>%
  select(Sample.Name = sample_name, depth = depth_m, Symbiodinium = A, Breviolum = B, Cladocopium = C, Gerakladium = G)%>%
  mutate("Durusdinium" = 0) %>%
  select(Sample.Name, depth, Symbiodinium, Breviolum, Cladocopium, Durusdinium)
  
```

# Import Manzello Florida Keys 2019 Data
```{r}
KEY <- readxl::read_xlsx(path = "Data/Manzello_Florida_Keys_2019/qPCR_Raw_Data_FL_Keys_2015-2016.xlsx")

KEY_fig_dat <- KEY %>%
  select(Sample.Name, time_point, condition, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = sym, value = value, -Sample.Name, -time_point, -condition)

initial <- KEY_fig_dat %>%
  filter(time_point == "initial") %>%
  filter(condition == "H" | condition == "B" | condition == "PB" | condition == "P")

i <- ggplot(initial, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~condition, space = "free", scales = "free") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c')) +
  ggtitle("Initial") +
  theme(legend.position = "none")

final <- KEY_fig_dat %>%
  filter(time_point == "final") %>%
  filter(condition == "H" | condition == "B" | condition == "PB" | condition == "P")

f <- ggplot(final, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~condition, space = "free", scales = "free") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c')) +
  ggtitle("Final")

library(ggpubr) 
ggarrange(i,f)
ggsave(filename = "all_KEYS.png", width = 300, height = 150, units = "mm")

KEY_healthy <- KEY %>%
  filter(condition == "H")

KEY_H_dupes <- KEY_healthy %>%
  group_by(tag_number) %>%
  count(vars = "tag_number") %>%
  filter(n > 1) 

#Gathering the full data for samples with 2 replicates
KEY_dupes_dat <- KEY_healthy %>%
  filter(tag_number %in% KEY_H_dupes$tag_number) %>%
  arrange(tag_number)

KEY_dupes_initial <- KEY_dupes_dat %>%
  filter(time_point == "initial")

KEY_H_single <- KEY_healthy %>%
  filter(!(Sample.Name %in% KEY_dupes_dat$Sample.Name))

KEY_Ofav <- rbind(KEY_dupes_initial, KEY_H_single) %>%
  select(Sample.Name, depth = depth_m, Symbiodinium, Breviolum, Cladocopium, Durusdinium)


KEY_Samps <- KEY_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = sym, value = value, -Sample.Name)

ggplot(KEY_Samps, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c')) +
  theme(legend.position = "bottom")

 ggsave(filename = "healthy_KEYS.png", width = 84, height = 100, units = "mm")



```

# Import Karp Miami Data
```{r}
MIA1 <- readxl::read_xlsx("Data/Karp_Miami_Unpublished/Karp_Emerald_Reef.xlsx") %>%
  filter(SampleName != NaN) 

MIA2 <- readxl::read_xlsx("Data/Karp_Miami_Unpublished/Karp_Fisher_Island.xlsx") %>%
  filter(SampleName != NaN) 

MIA3 <- readxl::read_xlsx("Data/Karp_Miami_Unpublished/Karp_Dry_Tortugas.xlsx") %>%
  filter(Sample.Name != NaN)

# Renaming and selecting columns from Raw Data Files
MIA1_Ofav <- MIA1 %>%
  filter(Species == "Ofav") %>%
  select(Sample.Name = SampleName, depth = depth_m, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean,
  A.CT.sd,B.CT.sd, C.CT.sd, D.CT.sd, A.reps, B.reps, C.reps, D.reps) %>%
  mutate(A.CT.mean = as.numeric(A.CT.mean),
         B.CT.mean = as.numeric(B.CT.mean),
         C.CT.mean = as.numeric(C.CT.mean),
         D.CT.mean = as.numeric(D.CT.mean))

MIA2_Ofav <- MIA2 %>% 
 filter(Species == "Ofav") %>%
  select(Sample.Name = SampleName, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean,
  A.CT.sd,B.CT.sd, C.CT.sd, D.CT.sd, A.reps, B.reps, C.reps, D.reps) %>%
  mutate(A.CT.mean = as.numeric(A.CT.mean),
         B.CT.mean = as.numeric(B.CT.mean),
         C.CT.mean = as.numeric(C.CT.mean),
         D.CT.mean = as.numeric(D.CT.mean)) %>%
  mutate(depth = NaN)

MIA3_Ofav <- MIA3 %>%
  filter(Species == "OFAV") %>%
  select(Sample.Name, A.CT.mean, depth = depth_m, B.CT.mean, C.CT.mean, D.CT.mean,
  A.CT.sd,B.CT.sd, C.CT.sd, D.CT.sd, A.reps, B.reps, C.reps, D.reps) %>%
   mutate(A.CT.mean = as.numeric(A.CT.mean),
         B.CT.mean = as.numeric(B.CT.mean),
         C.CT.mean = as.numeric(C.CT.mean),
         D.CT.mean = as.numeric(D.CT.mean))

#Combining all 3 MIA Datasets 
qpcr_MIA_Ofav <- rbind(MIA1_Ofav, MIA2_Ofav, MIA3_Ofav) %>%
  filter(A.reps != 1, B.reps != 1, C.reps != 1, D.reps != 1)


# adjust CT to form ratio of Symbiont divided by Copy # (Currently a Placeholder #)
MIA_copy_num <- qpcr_MIA_Ofav %>%
  mutate(N = 15) %>%
  mutate(A.N = 2^(N - A.CT.mean)/1,
         B.N = 2^(N - B.CT.mean)/1,
         C.N = 2^(N - C.CT.mean)/1,
         D.N = 2^(N - D.CT.mean)/1)
# Convert Na to 0
MIA_qpcr_prop <- MIA_copy_num %>%
  mutate(A.N = ifelse(is.na(A.N), 0, A.N),
         B.N = ifelse(is.na(B.N), 0, B.N),
         C.N = ifelse(is.na(C.N), 0, C.N),
         D.N = ifelse(is.na(D.N), 0, D.N)) %>%
  rowwise() %>%
  mutate(total = sum(A.N + B.N + C.N + D.N))%>%
  mutate(A.prop = A.N/total, B.prop = B.N/total, C.prop = C.N/total, D.prop = D.N/total)

# Renaming Clade Proportion to Genus Proportion 
MIA_Ofav <- MIA_qpcr_prop %>%
  select(Sample.Name, depth, Symbiodinium = A.prop, Breviolum = B.prop, Cladocopium = C.prop, Durusdinium = D.prop) %>%
  mutate(depth = NA)

```


# Combining Exumas, Abacao, Curaco, Florida Keys & establishing Dominant Symbiont
```{r}
Ofav<- rbind(EXAB_Ofav, KEY_Ofav, CUR_Ofav, MIA_Ofav) %>%
  filter(Sample.Name != "NEC6", Sample.Name != "PTC") %>% # GO BACK AND SEE WHY THESE SLIP THROUGH
  mutate(dom_sym = case_when(Breviolum > Cladocopium & Breviolum > Durusdinium & Breviolum > Symbiodinium
                             ~ "Breviolum",
                             Cladocopium > Breviolum & Cladocopium > Durusdinium & Cladocopium > Symbiodinium
                             ~ "Cladocopium",
                             Durusdinium > Breviolum & Durusdinium > Cladocopium & Durusdinium > Symbiodinium
                             ~ "Durusdinium",
                             Symbiodinium > Breviolum & Symbiodinium > Cladocopium & Symbiodinium >
                             Durusdinium ~ "Symbiodinium")) %>%
  select(Sample.Name, depth, Symbiodinium, Breviolum, Cladocopium, Durusdinium, dom_sym) %>%
  ungroup() 

```


# Stacked Bar Plot of Symbiont Composition per Sample  
```{r}
all_sym_comp <- Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = "sym", value = "value", -Sample.Name) 


ggplot(all_sym_comp, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))

```

#Dominant Symbiont Proportion across Depth
```{r}
dom_sym <- Ofav %>%
  select(Sample.Name, depth, dom_sym) %>%
  filter(depth != "NA") %>%
  mutate(depth_int = cut(depth, breaks = 8)) %>%
  group_by(depth_int, dom_sym) %>%
  summarise(ncol = n()) %>%
  mutate(n = sum(ncol), label = paste0("N =", n)) %>%
  mutate(prop = ncol/n)


ggplot(dom_sym, aes(x = as.factor(depth_int), y = ncol, fill = dom_sym)) +
  geom_bar(stat = "identity", position = "fill", size =20) +
  geom_text(aes(x = as.factor(depth_int), y = 1.05, label =label), inherit.aes = FALSE) +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))
```

# Dominant Symbiont Proportion less than 8m
```{r}
dom_sym_shallow <- Ofav %>%
  filter(depth < 8) %>%
  select(Sample.Name, depth, dom_sym) %>%
  filter(depth != "NA") %>%
  mutate(depth_int = cut(depth, breaks = 8)) %>%
  group_by(depth_int, dom_sym) %>%
  summarise(ncol = n()) %>%
  mutate(n = sum(ncol), label = paste0("N =", n)) %>%
  mutate(prop = ncol/n)

ggplot(dom_sym_shallow, aes(x = as.factor(depth_int), y = ncol, fill = dom_sym)) +
  geom_bar(stat = "identity", position = "fill", size =20) +
  geom_text(aes(x = as.factor(depth_int), y = 1.05, label =label), inherit.aes = FALSE) +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))
```

#Converting Proportion decimals to percent 
```{r}
no_round <- Ofav %>%
    select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
    mutate(Symbiodinium = Symbiodinium * 100, 
          Breviolum = Breviolum * 100, 
          Cladocopium = Cladocopium * 100, 
          Durusdinium = Durusdinium * 100) %>%
  select(Sample.Name, A = Symbiodinium, B = Breviolum, C = Cladocopium, D = Durusdinium) %>%
  mutate(pattern = case_when(A > 0 & B == 0 & C == 0 & D == 0 ~ "A",
                             A == 0 & B > 0 & C == 0 & D == 0 ~ "B",
                             A == 0 & B == 0 & C > 0 & D == 0 ~ "C",
                             A == 0 & B == 0 & C == 0 & D > 0 ~ "D",
                             A > 0 & B > 0 & C == 0 & D == 0 ~ "AB",
                             A > 0 & B == 0 & C > 0 & D == 0 ~ "AC",
                             A > 0 & B == 0 & C == 0 & D > 0 ~ "AD",
                             A == 0 & B > 0 & C > 0 & D == 0 ~ "BC",
                             A == 0 & B > 0 & C == 0 & D > 0 ~ "BD",
                             A == 0 & B == 0 & C > 0 & D > 0 ~ "CD",
                             A > 0 & B > 0 & C > 0 & D == 0 ~ "ABC",
                             A > 0 & B > 0 & C == 0 & D > 0 ~ "ABD",
                             A > 0 & B == 0 & C > 0 & D > 0 ~ "ACD",
                             A == 0 & B > 0 & C > 0 & D > 0 ~ "BCD",
                             A > 0 & B > 0 & C > 0 & D > 0 ~ "ABCD"))

no_round %>%
  group_by(pattern) %>%
  count(vars = "pattern") %>%
  select(pattern, n)









round_0_dec <- Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  mutate(Symbiodinium = Symbiodinium * 100, 
          Breviolum = Breviolum * 100, 
          Cladocopium = Cladocopium * 100, 
          Durusdinium = Durusdinium * 100) %>%
  mutate(Symbiodinium = round(Symbiodinium, digits = 0),
         Breviolum = round(Breviolum, digits = 0),
         Cladocopium = round(Cladocopium, digits = 0),
         Durusdinium = round(Durusdinium, digits = 0)) %>%
  mutate(total = Symbiodinium + Breviolum + Cladocopium + Durusdinium)


zero_dec <- round_0_dec %>%
  select(Sample.Name, A = Symbiodinium, B = Breviolum, C = Cladocopium, D = Durusdinium) %>%
  mutate(pattern = case_when(A > 0 & B == 0 & C == 0 & D == 0 ~ "A",
                             A == 0 & B > 0 & C == 0 & D == 0 ~ "B",
                             A == 0 & B == 0 & C > 0 & D == 0 ~ "C",
                             A == 0 & B == 0 & C == 0 & D > 0 ~ "D",
                             A > 0 & B > 0 & C == 0 & D == 0 ~ "AB",
                             A > 0 & B == 0 & C > 0 & D == 0 ~ "AC",
                             A > 0 & B == 0 & C == 0 & D > 0 ~ "AD",
                             A == 0 & B > 0 & C > 0 & D == 0 ~ "BC",
                             A == 0 & B > 0 & C == 0 & D > 0 ~ "BD",
                             A == 0 & B == 0 & C > 0 & D > 0 ~ "CD",
                             A > 0 & B > 0 & C > 0 & D == 0 ~ "ABC",
                             A > 0 & B > 0 & C == 0 & D > 0 ~ "ABD",
                             A > 0 & B == 0 & C > 0 & D > 0 ~ "ACD",
                             A == 0 & B > 0 & C > 0 & D > 0 ~ "BCD",
                             A > 0 & B > 0 & C > 0 & D > 0 ~ "ABCD"))
round_1_dec <- Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  mutate(Symbiodinium = Symbiodinium * 100, 
          Breviolum = Breviolum * 100, 
          Cladocopium = Cladocopium * 100, 
          Durusdinium = Durusdinium * 100) %>%
  mutate(Symbiodinium = round(Symbiodinium, digits = 1),
         Breviolum = round(Breviolum, digits = 1),
         Cladocopium = round(Cladocopium, digits = 1),
         Durusdinium = round(Durusdinium, digits = 1)) %>%
  mutate(total = Symbiodinium + Breviolum + Cladocopium + Durusdinium)

one_dec <- round_1_dec %>%
  select(Sample.Name, A = Symbiodinium, B = Breviolum, C = Cladocopium, D = Durusdinium) %>%
  mutate(pattern = case_when(A > 0 & B == 0 & C == 0 & D == 0 ~ "A",
                             A == 0 & B > 0 & C == 0 & D == 0 ~ "B",
                             A == 0 & B == 0 & C > 0 & D == 0 ~ "C",
                             A == 0 & B == 0 & C == 0 & D > 0 ~ "D",
                             A > 0 & B > 0 & C == 0 & D == 0 ~ "AB",
                             A > 0 & B == 0 & C > 0 & D == 0 ~ "AC",
                             A > 0 & B == 0 & C == 0 & D > 0 ~ "AD",
                             A == 0 & B > 0 & C > 0 & D == 0 ~ "BC",
                             A == 0 & B > 0 & C == 0 & D > 0 ~ "BD",
                             A == 0 & B == 0 & C > 0 & D > 0 ~ "CD",
                             A > 0 & B > 0 & C > 0 & D == 0 ~ "ABC",
                             A > 0 & B > 0 & C == 0 & D > 0 ~ "ABD",
                             A > 0 & B == 0 & C > 0 & D > 0 ~ "ACD",
                             A == 0 & B > 0 & C > 0 & D > 0 ~ "BCD",
                             A > 0 & B > 0 & C > 0 & D > 0 ~ "ABCD"))

round_2_dec <- Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  mutate(Symbiodinium = Symbiodinium * 100, 
          Breviolum = Breviolum * 100, 
          Cladocopium = Cladocopium * 100, 
          Durusdinium = Durusdinium * 100) %>%
  mutate(Symbiodinium = round(Symbiodinium, digits = 2),
         Breviolum = round(Breviolum, digits = 2),
         Cladocopium = round(Cladocopium, digits = 2),
         Durusdinium = round(Durusdinium, digits = 2)) %>%
  mutate(total = Symbiodinium + Breviolum + Cladocopium + Durusdinium)

two_dec <- round_2_dec %>%
  select(Sample.Name, A = Symbiodinium, B = Breviolum, C = Cladocopium, D = Durusdinium) %>%
  mutate(pattern = case_when(A > 0 & B == 0 & C == 0 & D == 0 ~ "A",
                             A == 0 & B > 0 & C == 0 & D == 0 ~ "B",
                             A == 0 & B == 0 & C > 0 & D == 0 ~ "C",
                             A == 0 & B == 0 & C == 0 & D > 0 ~ "D",
                             A > 0 & B > 0 & C == 0 & D == 0 ~ "AB",
                             A > 0 & B == 0 & C > 0 & D == 0 ~ "AC",
                             A > 0 & B == 0 & C == 0 & D > 0 ~ "AD",
                             A == 0 & B > 0 & C > 0 & D == 0 ~ "BC",
                             A == 0 & B > 0 & C == 0 & D > 0 ~ "BD",
                             A == 0 & B == 0 & C > 0 & D > 0 ~ "CD",
                             A > 0 & B > 0 & C > 0 & D == 0 ~ "ABC",
                             A > 0 & B > 0 & C == 0 & D > 0 ~ "ABD",
                             A > 0 & B == 0 & C > 0 & D > 0 ~ "ACD",
                             A == 0 & B > 0 & C > 0 & D > 0 ~ "BCD",
                             A > 0 & B > 0 & C > 0 & D > 0 ~ "ABCD"))

a <- zero_dec %>%
   group_by(pattern) %>%
  count(vars = "pattern") %>%
  select(pattern, n)

b <- one_dec %>%
  group_by(pattern) %>%
  count(vars = "pattern") %>%
  select(pattern, n) 

c <- two_dec %>%
  group_by(pattern) %>%
  count(vars = "pattern") %>%
  select(pattern, n)

r <- right_join(a, b, by = "pattern")

l <- right_join(r, c, by = "pattern") %>%
  rename(zero = n.x, one = n.y, two = n)
```


```{r}
distinct_combos <- zero_dec %>%
  distinct(A, B, C, D, .keep_all = TRUE)
```


#Network Analysis 
```{r}
library(igraph)

Ofav_mix <- Ofav %>%
  filter(Symbiodinium != 1 & Breviolum != 1 & Cladocopium != 1 & Durusdinium != 1)

net_data_orb <- Ofav_mix %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

edges_orb <- net_data_orb %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

depth_orb <- Ofav %>%
  select(Sample.Name, depth)

verts_orb <- tibble(Sample.Name = c(net_data_orb$Sample.Name, colnames(net_data_orb)[-1])) %>%
  left_join(depth_orb) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

net_orb <- graph_from_data_frame(edges_orb, directed = FALSE, vertices = verts_orb)

set.seed(7)

plot(net_orb, edge.curved = 0,
     edge.width = 2 * (E(net_orb)$weight)^0.4, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(net_orb)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(net_orb))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(net_orb))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(net_orb)$depth,breaks = 100))]))
```


#Network with distinct samples
```{r}
library(igraph)

net_data_distinct <- distinct_combos %>%
  select(Sample.Name, Symbiodinium = A, Breviolum = B, Cladocopium = C, Durusdinium = D)

edges_distinct <- net_data_distinct %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

depth_distinct <- Ofav %>%
  filter(Sample.Name %in% distinct_combos$Sample.Name) %>%
  select(Sample.Name, depth)

verts_distinct <- tibble(Sample.Name = c(net_data_distinct$Sample.Name, colnames(net_data_distinct)[-1])) %>%
  left_join(depth_distinct) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

net_distinct <- graph_from_data_frame(edges_distinct, directed = FALSE, vertices = verts_distinct)

set.seed(15)

plot(net_distinct, edge.curved = 0,
     edge.width = 2 * (E(net_distinct)$weight)^0.07, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(net_distinct)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(net_distinct))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(net_distinct))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(net_distinct)$depth,breaks = 100))]))

ggsave(filename = "distinct_sample_network.png", width = 300, height = 150, units = "mm")

ggsave(filename = "distinct_network.png", width = 300, height = 150, units = "mm")


```















```{r}
Ofav

Ofav_pa <- Ofav %>%
  select(Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  mutate_at(vars(Symbiodinium, Breviolum, Cladocopium, Durusdinium), 
            function(x) x > 0)

Ofav_pa

vennCounts(Ofav_pa)
vennDiagram(Ofav_pa)
```

```{r}
edges <- tribble(
  ~colA, ~colB, ~weight,
  "A", "B", 12,
  "A", "C", 7,
  "A", "D", 3,
  "B", "C", 11,
  "B", "D", 6,
  "C", "D", 6
)
nodes <- c("A", "B", "C", "D")

nn <- graph_from_data_frame(edges, directed = FALSE, vertices = nodes)
plot(nn, edge.width = E(nn)$weight)
```

