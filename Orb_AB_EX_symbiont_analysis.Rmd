---
title: "Orb_EX_AB_sym_analysis"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(devtools)   # install.packages("devtools")
library(steponeR) # install_github("jrcunning/steponeR")
library(tidyverse) # (install.packages("tidyverse")
```

# Data Key
# AB  <- Parker_Abaco_2020
# EX  <- Unpublished_Exumas
# KEY <- Manzello_Florida_Keys_2019
# MIA <- Karp_Miami_Unpublished
# DRT <- Karp_Dry_Tortugas
# CUR <- Green_Curaco_2014
# WEL <- Williamson_Eluthera
# WER <- Williamson_Emerald_Reef

# Import Abaco Data
```{r}
AB1 <- readxl::read_xlsx("Data/Parker_Abaco_2019/Parker_Abaco_2019.xlsx")

AB <- AB1 %>%
  select(Sample.Name, region, site, depth, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean, A.CT.sd,B.CT.sd, C.CT.sd, D.CT.sd, A.reps, B.reps, C.reps, D.reps ) %>%
    mutate(A.CT.mean = as.numeric(A.CT.mean),
         B.CT.mean = as.numeric(B.CT.mean),
         C.CT.mean = as.numeric(C.CT.mean),
         D.CT.mean = as.numeric(D.CT.mean))


# adjust CT for flouresence 
AB_qpcr <- AB %>%
  mutate(A.CT.mean = A.CT.mean - 1,
         B.CT.mean = B.CT.mean - 1,
         C.CT.mean = C.CT.mean - 1,
         D.CT.mean = D.CT.mean - 1)

```

#Import Karp Miami and Karp Dry Tortugas 
```{r}
MIA1 <- readxl::read_xlsx("Data/Karp_Miami_Unpublished/Karp_Emerald_Reef.xlsx") %>%
  filter(Species == "Ofav") %>%
  filter(SampleName != NaN) 

MIA1_qpcr <- MIA1 %>%
  filter(Species == "Ofav") %>%
  select(Sample.Name = SampleName, site = Reef, depth = depth_m, A.D, B.D, C.D, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean,
  A.CT.sd,B.CT.sd, C.CT.sd, D.CT.sd, A.reps, B.reps, C.reps, D.reps)

MIA2 <- readxl::read_xlsx("Data/Karp_Miami_Unpublished/Karp_Fisher_Island.xlsx") %>%
  filter(SampleName != NaN)

MIA2_qpcr <- MIA2 %>% 
 filter(Species == "Ofav") %>%
  select(Sample.Name = SampleName, site = Location, A.D, B.D, C.D, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean,
  A.CT.sd,B.CT.sd, C.CT.sd, D.CT.sd, A.reps, B.reps, C.reps, D.reps) %>%
  mutate(depth = NaN)

DRT1 <- readxl::read_xlsx("Data/Karp_Dry_Tortugas/Karp_Dry_Tortugas.xlsx") %>%
  filter(Sample.Name != NaN)

DRT_qpcr <- DRT1 %>%
  filter(Species == "OFAV") %>%
  select(Sample.Name, depth = depth_m, A.D, B.D, C.D, A.CT.mean,B.CT.mean, C.CT.mean, D.CT.mean,
  A.CT.sd,B.CT.sd, C.CT.sd, D.CT.sd, A.reps, B.reps, C.reps, D.reps) %>%
  mutate(site = "Dry_Tortugas") %>%
  mutate(region = "Dry_Tortugas")

karp_qpcr <- rbind(MIA1_qpcr, MIA2_qpcr) %>%
  mutate(region = "Miami") %>%
  rbind(DRT_qpcr) %>%
  select(Sample.Name, region, site, depth, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean, A.CT.sd,B.CT.sd, C.CT.sd, D.CT.sd, A.reps, B.reps, C.reps, D.reps ) %>%
      mutate(A.CT.mean = as.numeric(A.CT.mean),
         B.CT.mean = as.numeric(B.CT.mean),
         C.CT.mean = as.numeric(C.CT.mean),
         D.CT.mean = as.numeric(D.CT.mean))

```


# Import Williamson Data
```{r}
WEL1 <- readxl::read_xlsx("Data/Williamson_Eluthera/Williamson_Eluthera.xlsx")

WEL_qpcr<- WEL1 %>%
  select(Sample.Name, site, depth, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean, A.reps, B.reps, C.reps, D.reps, A.D, B.D, C.D) %>%
  mutate(region = "Eluthera")


WER1 <- readxl::read_xlsx("Data/Williamson_Emerald_Reef/Williamson_Emerald_Reef.xlsx")


WER_qpcr <- WER1 %>% 
  select(Sample.Name, site, depth, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean, A.reps, B.reps, C.reps, D.reps, A.D, B.D, C.D) %>%
  mutate(region = "Miami")

williamson_qpcr <- rbind(WEL_qpcr, WER_qpcr) %>%
  mutate(A.CT.sd = 0, B.CT.sd = 0, C.CT.sd = 0, D.CT.sd = 0) %>% 
  mutate(A.D = as.numeric(A.D),
         B.D = as.numeric(B.D),
         C.D = as.numeric(C.D),
         D.D = as.numeric(1)) %>%
  mutate(A.D = ifelse(is.na(A.D), 0, A.D),
         B.D = ifelse(is.na(B.D), 0, B.D),
         C.D = ifelse(is.na(C.D), 0, C.D))
 

williamson_prop <- williamson_qpcr %>%
  mutate(total = A.D + B.D + C.D + D.D) %>%
  mutate(A.prop = A.D/total,
         B.prop = B.D/total,
         C.prop = C.D/total, 
         D.prop = D.D/total) %>%
  select(Sample.Name, region, site, depth, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean, A.CT.sd, B.CT.sd, C.CT.sd, D.CT.sd, A.reps, B.reps, C.reps, D.reps, Symbiodinium = A.prop, Breviolum = B.prop, Cladocopium = C.prop, Durusdinium = D.prop)
```


# Establishing Proportions for Abaco, Karp, and Williamson Data
```{r}
prop_calc <- rbind(AB_qpcr, karp_qpcr)

# adjust CT to form ratio of Symbiont divided by Copy # (Currently a Placeholder #)
qpcr_copy_num <- prop_calc %>%
  mutate(N = 15) %>%
  mutate(A.N = 2^(N - A.CT.mean)/1,
         B.N = 2^(N - B.CT.mean)/1,
         C.N = 2^(N - C.CT.mean)/1,
         D.N = 2^(N - D.CT.mean)/1)

qpcr_prop <- qpcr_copy_num %>%
  mutate(A.N = ifelse(is.na(A.N), 0, A.N),
         B.N = ifelse(is.na(B.N), 0, B.N),
         C.N = ifelse(is.na(C.N), 0, C.N),
         D.N = ifelse(is.na(D.N), 0, D.N)) %>%
  rowwise() %>%
  mutate(total = sum(A.N + B.N + C.N + D.N))%>%
  mutate(Symbiodinium = A.N/total, 
         Breviolum = B.N/total,
         Cladocopium = C.N/total, 
         Durusdinium = D.N/total) 
```


```{r}
need_to_clean <-qpcr_prop %>%
  select(Sample.Name, region, site, depth, A.CT.mean, B.CT.mean, C.CT.mean, D.CT.mean, A.CT.sd, B.CT.sd, C.CT.sd, 
         D.CT.sd, A.reps, B.reps, C.reps, D.reps, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  rbind(williamson_prop) %>%
    mutate(A.CT.mean = ifelse(is.na(A.CT.mean), 0, A.CT.mean),
         B.CT.mean = ifelse(is.na(B.CT.mean), 0, B.CT.mean),
         C.CT.mean = ifelse(is.na(C.CT.mean), 0, C.CT.mean),
         D.CT.mean = ifelse(is.na(D.CT.mean), 0, D.CT.mean))

fails <- need_to_clean %>%
  filter(A.CT.mean == 0 & B.CT.mean == 0 & C.CT.mean == 0 & D.CT.mean == 0)
  
tidy_qpcr <- need_to_clean %>%
  filter(!Sample.Name %in% fails$Sample.Name) %>%
  filter(A.reps != 1 , B.reps != 1 , C.reps != 1 , D.reps != 1) %>%
  filter(A.CT.sd < 1 | B.CT.sd < 1 | C.CT.sd < 1 | D.CT.sd < 1) %>%
  mutate(depth = as.numeric(as.character(depth)))
  
```


# Abaco (Parker)
```{r}
AB_Ofav <- tidy_qpcr %>%
  filter(region == "Abaco") %>%
  select(Sample.Name, site, region, depth, Symbiodinium, Breviolum, Cladocopium, Durusdinium) 

# Symbiodiniaceae composition per sample Abaco
AB_comp <- AB_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = "sym", value = "value", -Sample.Name) 

ggplot(AB_comp, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))

# Network Symbiodiniaceae Abaco
library(igraph)

AB_net_data <- AB_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

AB_edges <- AB_net_data %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

AB_depth <- AB_Ofav %>%
  select(Sample.Name, depth)

AB_verts <- tibble(Sample.Name = c(AB_net_data$Sample.Name, colnames(AB_net_data)[-1])) %>%
  left_join(AB_depth) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

AB_net <- graph_from_data_frame(AB_edges, directed = FALSE, vertices = AB_verts)

set.seed(8)

plot(AB_net, edge.curved = 0,
     edge.width = 2 * (E(AB_net)$weight)^0.4, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(AB_net)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(AB_net))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(AB_net))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(AB_net)$depth,breaks = 100))]))


```

# Miami (Karp & Williamson)
```{r}
MIA_Ofav <- tidy_qpcr %>%
  filter(region == "Miami") %>%
  select(Sample.Name, site, region, depth, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  filter(Sample.Name != "ofav94") %>%
  mutate(site = ifelse(site == "Emerald", "Emerald_Reef", site)) %>%
  mutate(site = ifelse(site == "Emerald Reef", "Emerald_Reef", site))

MIA_comp <- MIA_Ofav %>%
  select(Sample.Name, site, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = "sym", value = "value", -Sample.Name, -site) 

ggplot(MIA_comp, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~ site, scales = "free") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))

# Network Curacao
MIA_net_data <- MIA_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

MIA_edges <- MIA_net_data %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

MIA_depth <- MIA_Ofav %>%
  select(Sample.Name, depth)

MIA_verts <- tibble(Sample.Name = c(MIA_net_data$Sample.Name, colnames(MIA_net_data)[-1])) %>%
  left_join(MIA_depth) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

MIA_net <- graph_from_data_frame(MIA_edges, directed = FALSE, vertices = MIA_verts)

set.seed(8)

plot(MIA_net, edge.curved = 0,
     edge.width = 2 * (E(MIA_net)$weight)^0.4, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(MIA_net)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(MIA_net))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(MIA_net))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(MIA_net)$depth,breaks = 100))]))

```

# Dry Tortugas (Karp)
```{r}
DRT_Ofav <- tidy_qpcr %>%
  filter(region == "Dry_Tortugas") %>%
  select(Sample.Name, site, region, depth, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

DRT_comp <- DRT_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = "sym", value = "value", -Sample.Name) 


ggplot(DRT_comp, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))


#Network Dry Tortugas
DRT_net_data <- DRT_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

DRT_edges <- DRT_net_data %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

DRT_depth <- DRT_Ofav %>%
  select(Sample.Name, depth)

DRT_verts <- tibble(Sample.Name = c(DRT_net_data$Sample.Name, colnames(DRT_net_data)[-1])) %>%
  left_join(DRT_depth) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

DRT_net <- graph_from_data_frame(DRT_edges, directed = FALSE, vertices = DRT_verts)

set.seed(8)

plot(DRT_net, edge.curved = 0,
     edge.width = 2 * (E(DRT_net)$weight)^0.4, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(DRT_net)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(DRT_net))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(DRT_net))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(DRT_net)$depth,breaks = 100))]))
```

# Eluthera (Williamson)
```{r}
ELU_Ofav <- tidy_qpcr %>%
  filter(region == "Eluthera") %>%
  select(Sample.Name, site, region, depth, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

ELU_comp <- ELU_Ofav %>%
  select(Sample.Name, site, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = "sym", value = "value", -Sample.Name, -site) 


ggplot(ELU_comp, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~ site, scales = "free") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))


#Network Eluthera
ELU_net_data <- ELU_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

ELU_edges <- ELU_net_data %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

ELU_depth <- ELU_Ofav %>%
  select(Sample.Name, depth)

ELU_verts <- tibble(Sample.Name = c(ELU_net_data$Sample.Name, colnames(ELU_net_data)[-1])) %>%
  left_join(ELU_depth) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

ELU_net <- graph_from_data_frame(ELU_edges, directed = FALSE, vertices = ELU_verts)

set.seed(8)

plot(ELU_net, edge.curved = 0,
     edge.width = 2 * (E(ELU_net)$weight)^0.4, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(ELU_net)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(ELU_net))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(ELU_net))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(ELU_net)$depth,breaks = 100))]))

```

# Import Exumas Data 
```{r}
EX <- readxl::read_xlsx("Data/Unpublished_Exumas/Exumas_Unpublished.xlsx")

EX_Ofav <- EX %>%
  filter(species == "faveolata") %>%
  mutate(region = "Exumas") %>%
  select(Sample.Name, site, region, depth, Symbiodinium = A.prop, Breviolum = B.prop, 
         Cladocopium = C.prop, Durusdinium = D.prop) %>%
 mutate(depth = as.numeric(as.character(depth)))

EX_comp <- EX_Ofav %>%
  select(Sample.Name, site, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = "sym", value = "value", -Sample.Name, -site) 


ggplot(EX_comp, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_wrap(~ site, scales = "free") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))


#Network Exumas

EX_net_data <- EX_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

EX_edges <- EX_net_data %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

EX_depth <- EX_Ofav %>%
  select(Sample.Name, depth)

EX_verts <- tibble(Sample.Name = c(EX_net_data$Sample.Name, colnames(EX_net_data)[-1])) %>%
  left_join(EX_depth) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

EX_net <- graph_from_data_frame(EX_edges, directed = FALSE, vertices = EX_verts)

set.seed(8)

plot(EX_net, edge.curved = 0,
     edge.width = 2 * (E(EX_net)$weight)^0.4, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(EX_net)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(EX_net))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(EX_net))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(EX_net)$depth,breaks = 100))]))

```


#Import Green Curacao 2014 Data 
```{r}
CUR <- readxl::read_xlsx(path = "Data/Green_Curacao_2014/ITS2_green_curacao_data.xlsx") 

CUR_Ofav <- CUR %>%
  select(Sample.Name = sample_name, depth = depth_m, A.prop = A, B.prop = B, C.prop = C, G.prop = G)%>%
  mutate("D.prop" = 0) %>%
  select(Sample.Name, depth, Symbiodinium = A.prop, Breviolum = B.prop, 
         Cladocopium = C.prop, Durusdinium = D.prop) %>%
  mutate(region = "Curacao", site = "Curacao") %>%
  mutate(depth = as.numeric(as.character(depth)))

CUR_comp <- CUR_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = "sym", value = "value", -Sample.Name) 


ggplot(CUR_comp, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))

# Network Curacao
CUR_net_data <- CUR_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

CUR_edges <- CUR_net_data %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

CUR_depth <- CUR_Ofav %>%
  select(Sample.Name, depth)

CUR_verts <- tibble(Sample.Name = c(CUR_net_data$Sample.Name, colnames(CUR_net_data)[-1])) %>%
  left_join(CUR_depth) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

CUR_net <- graph_from_data_frame(CUR_edges, directed = FALSE, vertices = CUR_verts)

set.seed(8)

plot(CUR_net, edge.curved = 0,
     edge.width = 2 * (E(CUR_net)$weight)^0.4, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(CUR_net)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(CUR_net))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(CUR_net))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(CUR_net)$depth,breaks = 100))]))

```

#Import Manzello Data 
```{r}
KEY <- readxl::read_xlsx(path = "Data/Manzello_Florida_Keys_2019/qPCR_Raw_Data_FL_Keys_2015-2016.xlsx")

KEY_healthy <- KEY %>%
  filter(condition == "H")

KEY_H_dupes <- KEY_healthy %>%
  group_by(tag_number) %>%
  count(vars = "tag_number") %>%
  filter(n > 1) 

#Gathering the full data for samples with 2 replicates
KEY_dupes_dat <- KEY_healthy %>%
  filter(tag_number %in% KEY_H_dupes$tag_number) %>%
  arrange(tag_number)

KEY_dupes_initial <- KEY_dupes_dat %>%
  filter(time_point == "initial")

KEY_H_single <- KEY_healthy %>%
  filter(!(Sample.Name %in% KEY_dupes_dat$Sample.Name))

KEY_Ofav <- rbind(KEY_dupes_initial, KEY_H_single) %>%
  select(Sample.Name, site, depth = depth_m, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  mutate(region = case_when(grepl("LK", site) ~ "Lower_Keys",grepl("UK", site) ~ "Upper_Keys")) %>%
  mutate(depth = as.numeric(as.character(depth)))

KEY_comp <- KEY_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium, region) %>%
  gather(key = "sym", value = "value", -Sample.Name, -region) 


ggplot(KEY_comp, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_wrap(~ region, scales = "free") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))


# Network Florida Keys
KEY_net_data_u <- KEY_Ofav %>%
  filter(region == "Upper_Keys") %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

KEY_edges_u <- KEY_net_data_u %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

KEY_depth_u <- KEY_Ofav %>%
  filter(region == "Upper_Keys") %>%
  select(Sample.Name, depth)

KEY_verts_u <- tibble(Sample.Name = c(KEY_net_data_u$Sample.Name, colnames(KEY_net_data_u)[-1])) %>%
  left_join(KEY_depth_u) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

KEY_net_u <- graph_from_data_frame(KEY_edges_u, directed = FALSE, vertices = KEY_verts_u)

set.seed(8)

plot(KEY_net_u, edge.curved = 0,
     edge.width = 2 * (E(KEY_net_u)$weight)^0.4, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(KEY_net_u)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(KEY_net_u))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(KEY_net_u))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(KEY_net_u)$depth,breaks = 100))]))


# Network Figure Lower Keys
KEY_net_data_l <- KEY_Ofav %>%
  filter(region == "Lower_Keys") %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

KEY_edges_l <- KEY_net_data_l %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

KEY_depth_l <- KEY_Ofav %>%
  filter(region == "Lower_Keys") %>%
  select(Sample.Name, depth)

KEY_verts_l <- tibble(Sample.Name = c(KEY_net_data_l$Sample.Name, colnames(KEY_net_data_l)[-1])) %>%
  left_join(KEY_depth_l) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

KEY_net_l <- graph_from_data_frame(KEY_edges_l, directed = FALSE, vertices = KEY_verts_l)

set.seed(8)

plot(KEY_net_l, edge.curved = 0,
     edge.width = 2 * (E(KEY_net_l)$weight)^0.4, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(KEY_net_l)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(KEY_net_l))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(KEY_net_l))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(KEY_net_l)$depth,breaks = 100))]))


```



# Combining Exumas, Abacao, Curaco, Florida Keys & establishing Dominant Symbiont
```{r}
Ofav<- rbind(AB_Ofav, EX_Ofav, KEY_Ofav, CUR_Ofav, MIA_Ofav, DRT_Ofav, ELU_Ofav) %>%
  rename(A = Symbiodinium, B = Breviolum, C = Cladocopium, D = Durusdinium) %>%
  mutate(dom_sym = case_when(B > C & B > D & B > A ~ "B",
                             C > B & C > D & C > A ~ "C",
                             D > B & D > C & D > A ~ "D",
                             A > B & A > C & A > D ~ "A")) %>%
  mutate(pattern = case_when(A > 0 & B == 0 & C == 0 & D == 0 ~ "A",
                             A == 0 & B > 0 & C == 0 & D == 0 ~ "B",
                             A == 0 & B == 0 & C > 0 & D == 0 ~ "C",
                             A == 0 & B == 0 & C == 0 & D > 0 ~ "D",
                             A > 0 & B > 0 & C == 0 & D == 0 ~ "AB",
                             A > 0 & B == 0 & C > 0 & D == 0 ~ "AC",
                             A > 0 & B == 0 & C == 0 & D > 0 ~ "AD",
                             A == 0 & B > 0 & C > 0 & D == 0 ~ "BC",
                             A == 0 & B > 0 & C == 0 & D > 0 ~ "BD",
                             A == 0 & B == 0 & C > 0 & D > 0 ~ "CD",
                             A > 0 & B > 0 & C > 0 & D == 0 ~ "ABC",
                             A > 0 & B > 0 & C == 0 & D > 0 ~ "ABD",
                             A > 0 & B == 0 & C > 0 & D > 0 ~ "ACD",
                             A == 0 & B > 0 & C > 0 & D > 0 ~ "BCD",
                             A > 0 & B > 0 & C > 0 & D > 0 ~ "ABCD")) %>%
  select(Sample.Name, region, site, depth, Symbiodinium = A, Breviolum = B, Cladocopium = C, Durusdinium = D, dom_sym, pattern) %>%
  mutate(depth = as.numeric(depth)) %>%
  ungroup() 

```

# Plotting Depth of Samples from Each Region
```{r}
# Depth of Each Sample
depth <- Ofav %>%
  select(Sample.Name, region, depth)

# Depth Metrics
depth %>%
    summarize(
    mean = mean(depth, na.rm = TRUE),
    min = min(depth, na.rm = TRUE),
    max = max(depth, na.rm = TRUE),
    median = median(depth, na.rm = TRUE))

# Number of Samples per Region
sample_size <- depth %>%
  select(region, depth) %>%
  group_by(region) %>%
  tally() %>% 
  mutate(n = paste("n =", n))

#Depth Boxplot
ggplot(depth, aes(x = region, y = -(depth), fill = region)) +
  geom_violin(width = 3) +
  geom_text(data = sample_size, aes(x = region, y = 1.01, label = n)) +
  theme(legend.position = "none",
        axis.title.x = element_text(color = "transparent"))



```


# Plotting Dominant Symbiont vs Depth
```{r}
dom_sym_violin <- Ofav %>%
  select(Sample.Name, region, depth, dom_sym)

# Dominant Symbiont of all Data
ggplot(dom_sym_violin, aes(x = dom_sym, y = -(depth), fill = dom_sym))+
  geom_violin() +
  scale_fill_manual(values=c('#7CAE00','#00BFC4','#C77CFF','#F8766D')) +
  theme(axis.title.x = element_text(color = "transparent", size = 0.1),
        legend.position = "none")

# Each Dominant Symbiont by region
ggplot(dom_sym_violin, aes(x = dom_sym, y = -(depth), fill = dom_sym))+
  geom_violin() +
  facet_grid(~region) +
  scale_fill_manual(values=c('#7CAE00','#00BFC4','#C77CFF','#F8766D')) +
  theme(axis.text.x = element_text(color = "transparent", size = 0.1),
        axis.title.x = element_text(color = "transparent", size = 0.1),
        legend.position = "bottom")

```

#Symbiont Combinations vs Depth
```{r}
depth_combos <- Ofav %>%
  select(depth, pattern, region) %>%
  filter(depth > 0) %>%
  mutate(depth_int = cut(depth, breaks = 8)) %>%
  group_by(depth_int, pattern, region) %>%
  summarise(ncol = n()) %>%
  mutate(n = sum(ncol), label = paste0("N =", n)) %>%
  mutate(prop = ncol/n)

ggplot(depth_combos, aes(x = as.factor(depth_int), y = ncol, fill = region)) +
  geom_bar(stat = "identity", position = "fill") +
  geom_text(aes(x = as.factor(depth_int), y = 1.01, label = label), size = 3, inherit.aes = FALSE) +
  facet_wrap(~pattern) +
  theme(legend.direction = "horizontal", 
        legend.position = c(0.75,0.1),
        legend.text = element_text(size = 20),
        axis.text.x = element_text(angle = -12))

```


#Proportion of Symbionts each sample, facet by pattern 
```{r}
a <- Ofav %>%
  filter(pattern != "A", pattern != "B", pattern != "C", pattern != "D") %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium, dom_sym, pattern) %>%
  gather(key = "sym", value = "value", -Sample.Name, -pattern, -dom_sym)
  

ggplot(a, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_wrap(~pattern, scales = "free") +
  theme(legend.direction = "horizontal", 
        legend.position = c(0.75,0.1),
        legend.title = element_blank(),
        legend.text = element_text(size = 25),
        axis.text.x = element_text(color = "transparent", size = 0.3),
        axis.title.x = element_blank()) +
  scale_fill_manual(values=c('#7CAE00','#00BFC4','#C77CFF','#F8766D')) 
```

#Proportion of Dominant Symbiont for Patterns
```{r}
b <- a %>%
  select(Sample.Name, pattern, dom_sym) %>%
  group_by(pattern, dom_sym) %>%
  summarise(ncol = n()) %>%
  mutate(n = sum(ncol), label = paste0("N =", n))
  
ggplot(b, aes(x = pattern, y = ncol, fill = dom_sym)) +
  geom_bar(stat = "identity", position = "fill") +
  geom_text(aes(x = pattern, y = 1.05, label =label))
```


#Histogram of Whole Dataset
```{r}
hist <- Ofav %>%
  select(Sample.Name, dom_sym, pattern, A= Symbiodinium, B = Breviolum, C = Cladocopium, D = Durusdinium) %>%
  mutate(A = ifelse(A > 0, 1, 0),
         B = ifelse(B > 0, 1, 0),
         C = ifelse(C > 0, 1, 0),
         D = ifelse(D > 0, 1, 0)) %>%
  mutate(degree = A + B + C + D)

 ggplot(hist, aes(x = degree)) + 
   geom_histogram(binwidth = 0.9) +
   theme_bw()

 ggplot(hist, aes(x = degree)) + 
   geom_histogram(binwidth = 0.9) +
   facet_wrap(~dom_sym) +
   theme_bw()

```

#Tetrahedron
```{r}
library(compositions)
library(rgl)

z <- Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)
  
as.data.frame(z)

z <- cbind(runif(z$Symbiodinium), runif(z$Breviolum), runif(z$Cladocopium), runif(z$Durusdinium))

z <- z/rowSums(z)

Acomp <- acomp(z)

plot3D(Acomp,  cex=10, col="red", log=FALSE, coors=T, bbox=F, scale=F, center=F, axis.col=1, axes=TRUE)
```

```{r}
#Relative Abundance Each Symbiont 
S <- Ofav$Symbiodinium

B <- Ofav$Breviolum

C <- Ofav$Cladocopium

D <- Ofav$Durusdinium


# Tetrahedron Plot 
rgl.open()
rgl.bg(color = "white")
rgl.points(S, B, C, D, size = 5, color = "black")
rgl.lines(c(0, 1), c(0, 0), c(0, 0), color = "yellow") # x-axis
rgl.lines(c(0, 0), c(0, 1), c(0, 0), color = "red") # y-axis
rgl.lines(c(0, 0), c(0, 0), c(0, 1), color = "green") # z-axis
rgl.lines(c(0, 1), c(1, 0), c(0, 0), color = "black")
rgl.lines(c(0, 0), c(1, 0), c(0, 1), color = "black")
rgl.lines(c(1, 0), c(0, 0), c(0, 1), color = "black")





```




# Extra Manzello Analysis, determing which samples to use
```{r}

KEY_fig_dat <- KEY %>%
  select(Sample.Name, time_point, condition, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = sym, value = value, -Sample.Name, -time_point, -condition)

initial <- KEY_fig_dat %>%
  filter(time_point == "initial") %>%
  filter(condition == "H" | condition == "B" | condition == "PB" | condition == "P")

i <- ggplot(initial, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~condition, space = "free", scales = "free") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c')) +
  ggtitle("Initial") +
  theme(legend.position = "none")

final <- KEY_fig_dat %>%
  filter(time_point == "final") %>%
  filter(condition == "H" | condition == "B" | condition == "PB" | condition == "P")

f <- ggplot(final, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_grid(~condition, space = "free", scales = "free") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c')) +
  ggtitle("Final")

library(ggpubr) 
ggarrange(i,f)
ggsave(filename = "all_KEYS.png", width = 300, height = 150, units = "mm")

KEY_healthy <- KEY %>%
  filter(condition == "H")

KEY_H_dupes <- KEY_healthy %>%
  group_by(tag_number) %>%
  count(vars = "tag_number") %>%
  filter(n > 1) 

#Gathering the full data for samples with 2 replicates
KEY_dupes_dat <- KEY_healthy %>%
  filter(tag_number %in% KEY_H_dupes$tag_number) %>%
  arrange(tag_number)

KEY_dupes_initial <- KEY_dupes_dat %>%
  filter(time_point == "initial")

KEY_H_single <- KEY_healthy %>%
  filter(!(Sample.Name %in% KEY_dupes_dat$Sample.Name))

KEY_Ofav <- rbind(KEY_dupes_initial, KEY_H_single) %>%
  select(Sample.Name, site, depth = depth_m, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  mutate(region = case_when(grepl("LK", site) ~ "Lower_Keys",grepl("UK", site) ~ "Upper_Keys"))

KEY_Samps <- KEY_Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  gather(key = sym, value = value, -Sample.Name)

ggplot(KEY_Samps, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c')) +
  theme(legend.position = "bottom")

 #ggsave(filename = "healthy_KEYS.png", width = 84, height = 100, units = "mm")

```


# Stacked Bar Plot of Symbiont Composition per Sample  
```{r}
all_sym_comp <- Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium, region) %>%
  gather(key = "sym", value = "value", -Sample.Name, -region) 


ggplot(all_sym_comp, aes(x = Sample.Name, y = value, fill = sym)) +
  geom_bar(stat = "identity", position = "fill") +
  facet_wrap(~region, scales = "free") +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))

```

#Dominant Symbiont Proportion across Depth
```{r}
dom_sym <- Ofav %>%
  select(Sample.Name, depth, dom_sym) %>%
  filter(depth != "NaN") %>%
  mutate(depth_int = cut(depth, breaks = 8)) %>%
  group_by(depth_int, dom_sym) %>%
  summarise(ncol = n()) %>%
  mutate(n = sum(ncol), label = paste0("N =", n)) %>%
  mutate(prop = ncol/n)


ggplot(dom_sym, aes(x = as.factor(depth_int), y = ncol, fill = dom_sym)) +
  geom_bar(stat = "identity", position = "fill", size =20) +
  geom_text(aes(x = as.factor(depth_int), y = 1.05, label =label), inherit.aes = FALSE) +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))
```

# Dominant Symbiont Proportion less than 8m
```{r}
dom_sym_shallow <- Ofav %>%
  filter(depth < 8) %>%
  select(Sample.Name, depth, dom_sym) %>%
  filter(depth != "NaN") %>%
  mutate(depth_int = cut(depth, breaks = 8)) %>%
  group_by(depth_int, dom_sym) %>%
  summarise(ncol = n()) %>%
  mutate(n = sum(ncol), label = paste0("N =", n)) %>%
  mutate(prop = ncol/n)

ggplot(dom_sym_shallow, aes(x = as.factor(depth_int), y = ncol, fill = dom_sym)) +
  geom_bar(stat = "identity", position = "fill", size =20) +
  geom_text(aes(x = as.factor(depth_int), y = 1.05, label =label), inherit.aes = FALSE) +
  scale_fill_manual(values = c('#a6cee3','#1f78b4','#b2df8a','#33a02c'))
```

#Converting Proportion decimals to percent 
```{r}
no_round <- Ofav %>%
    select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
    mutate(Symbiodinium = Symbiodinium * 100, 
          Breviolum = Breviolum * 100, 
          Cladocopium = Cladocopium * 100, 
          Durusdinium = Durusdinium * 100) %>%
  select(Sample.Name, A = Symbiodinium, B = Breviolum, C = Cladocopium, D = Durusdinium) %>%
  mutate(pattern = case_when(A > 0 & B == 0 & C == 0 & D == 0 ~ "A",
                             A == 0 & B > 0 & C == 0 & D == 0 ~ "B",
                             A == 0 & B == 0 & C > 0 & D == 0 ~ "C",
                             A == 0 & B == 0 & C == 0 & D > 0 ~ "D",
                             A > 0 & B > 0 & C == 0 & D == 0 ~ "AB",
                             A > 0 & B == 0 & C > 0 & D == 0 ~ "AC",
                             A > 0 & B == 0 & C == 0 & D > 0 ~ "AD",
                             A == 0 & B > 0 & C > 0 & D == 0 ~ "BC",
                             A == 0 & B > 0 & C == 0 & D > 0 ~ "BD",
                             A == 0 & B == 0 & C > 0 & D > 0 ~ "CD",
                             A > 0 & B > 0 & C > 0 & D == 0 ~ "ABC",
                             A > 0 & B > 0 & C == 0 & D > 0 ~ "ABD",
                             A > 0 & B == 0 & C > 0 & D > 0 ~ "ACD",
                             A == 0 & B > 0 & C > 0 & D > 0 ~ "BCD",
                             A > 0 & B > 0 & C > 0 & D > 0 ~ "ABCD"))

no_round %>%
  group_by(pattern) %>%
  count(vars = "pattern") %>%
  select(pattern, n)

round_0_dec <- Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  mutate(Symbiodinium = Symbiodinium * 100, 
          Breviolum = Breviolum * 100, 
          Cladocopium = Cladocopium * 100, 
          Durusdinium = Durusdinium * 100) %>%
  mutate(Symbiodinium = round(Symbiodinium, digits = 0),
         Breviolum = round(Breviolum, digits = 0),
         Cladocopium = round(Cladocopium, digits = 0),
         Durusdinium = round(Durusdinium, digits = 0)) %>%
  mutate(total = Symbiodinium + Breviolum + Cladocopium + Durusdinium)


zero_dec <- round_0_dec %>%
  select(Sample.Name, A = Symbiodinium, B = Breviolum, C = Cladocopium, D = Durusdinium) %>%
  mutate(pattern = case_when(A > 0 & B == 0 & C == 0 & D == 0 ~ "A",
                             A == 0 & B > 0 & C == 0 & D == 0 ~ "B",
                             A == 0 & B == 0 & C > 0 & D == 0 ~ "C",
                             A == 0 & B == 0 & C == 0 & D > 0 ~ "D",
                             A > 0 & B > 0 & C == 0 & D == 0 ~ "AB",
                             A > 0 & B == 0 & C > 0 & D == 0 ~ "AC",
                             A > 0 & B == 0 & C == 0 & D > 0 ~ "AD",
                             A == 0 & B > 0 & C > 0 & D == 0 ~ "BC",
                             A == 0 & B > 0 & C == 0 & D > 0 ~ "BD",
                             A == 0 & B == 0 & C > 0 & D > 0 ~ "CD",
                             A > 0 & B > 0 & C > 0 & D == 0 ~ "ABC",
                             A > 0 & B > 0 & C == 0 & D > 0 ~ "ABD",
                             A > 0 & B == 0 & C > 0 & D > 0 ~ "ACD",
                             A == 0 & B > 0 & C > 0 & D > 0 ~ "BCD",
                             A > 0 & B > 0 & C > 0 & D > 0 ~ "ABCD"))
round_1_dec <- Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  mutate(Symbiodinium = Symbiodinium * 100, 
          Breviolum = Breviolum * 100, 
          Cladocopium = Cladocopium * 100, 
          Durusdinium = Durusdinium * 100) %>%
  mutate(Symbiodinium = round(Symbiodinium, digits = 1),
         Breviolum = round(Breviolum, digits = 1),
         Cladocopium = round(Cladocopium, digits = 1),
         Durusdinium = round(Durusdinium, digits = 1)) %>%
  mutate(total = Symbiodinium + Breviolum + Cladocopium + Durusdinium)

one_dec <- round_1_dec %>%
  select(Sample.Name, A = Symbiodinium, B = Breviolum, C = Cladocopium, D = Durusdinium) %>%
  mutate(pattern = case_when(A > 0 & B == 0 & C == 0 & D == 0 ~ "A",
                             A == 0 & B > 0 & C == 0 & D == 0 ~ "B",
                             A == 0 & B == 0 & C > 0 & D == 0 ~ "C",
                             A == 0 & B == 0 & C == 0 & D > 0 ~ "D",
                             A > 0 & B > 0 & C == 0 & D == 0 ~ "AB",
                             A > 0 & B == 0 & C > 0 & D == 0 ~ "AC",
                             A > 0 & B == 0 & C == 0 & D > 0 ~ "AD",
                             A == 0 & B > 0 & C > 0 & D == 0 ~ "BC",
                             A == 0 & B > 0 & C == 0 & D > 0 ~ "BD",
                             A == 0 & B == 0 & C > 0 & D > 0 ~ "CD",
                             A > 0 & B > 0 & C > 0 & D == 0 ~ "ABC",
                             A > 0 & B > 0 & C == 0 & D > 0 ~ "ABD",
                             A > 0 & B == 0 & C > 0 & D > 0 ~ "ACD",
                             A == 0 & B > 0 & C > 0 & D > 0 ~ "BCD",
                             A > 0 & B > 0 & C > 0 & D > 0 ~ "ABCD"))

round_2_dec <- Ofav %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  mutate(Symbiodinium = Symbiodinium * 100, 
          Breviolum = Breviolum * 100, 
          Cladocopium = Cladocopium * 100, 
          Durusdinium = Durusdinium * 100) %>%
  mutate(Symbiodinium = round(Symbiodinium, digits = 2),
         Breviolum = round(Breviolum, digits = 2),
         Cladocopium = round(Cladocopium, digits = 2),
         Durusdinium = round(Durusdinium, digits = 2)) %>%
  mutate(total = Symbiodinium + Breviolum + Cladocopium + Durusdinium)

two_dec <- round_2_dec %>%
  select(Sample.Name, A = Symbiodinium, B = Breviolum, C = Cladocopium, D = Durusdinium) %>%
  mutate(pattern = case_when(A > 0 & B == 0 & C == 0 & D == 0 ~ "A",
                             A == 0 & B > 0 & C == 0 & D == 0 ~ "B",
                             A == 0 & B == 0 & C > 0 & D == 0 ~ "C",
                             A == 0 & B == 0 & C == 0 & D > 0 ~ "D",
                             A > 0 & B > 0 & C == 0 & D == 0 ~ "AB",
                             A > 0 & B == 0 & C > 0 & D == 0 ~ "AC",
                             A > 0 & B == 0 & C == 0 & D > 0 ~ "AD",
                             A == 0 & B > 0 & C > 0 & D == 0 ~ "BC",
                             A == 0 & B > 0 & C == 0 & D > 0 ~ "BD",
                             A == 0 & B == 0 & C > 0 & D > 0 ~ "CD",
                             A > 0 & B > 0 & C > 0 & D == 0 ~ "ABC",
                             A > 0 & B > 0 & C == 0 & D > 0 ~ "ABD",
                             A > 0 & B == 0 & C > 0 & D > 0 ~ "ACD",
                             A == 0 & B > 0 & C > 0 & D > 0 ~ "BCD",
                             A > 0 & B > 0 & C > 0 & D > 0 ~ "ABCD"))

a <- zero_dec %>%
   group_by(pattern) %>%
  count(vars = "pattern") %>%
  select(pattern, n)

b <- one_dec %>%
  group_by(pattern) %>%
  count(vars = "pattern") %>%
  select(pattern, n) 

c <- two_dec %>%
  group_by(pattern) %>%
  count(vars = "pattern") %>%
  select(pattern, n)

r <- right_join(a, b, by = "pattern")

l <- right_join(r, c, by = "pattern") %>%
  rename(zero = n.x, one = n.y, two = n)
```

```{r}
distinct_combos <- zero_dec %>%
  distinct(A, B, C, D, .keep_all = TRUE)
```


#Network Analysis 
```{r}
library(igraph)

Ofav_mix <- Ofav %>%
  filter(Symbiodinium != 1 & Breviolum != 1 & Cladocopium != 1 & Durusdinium != 1)

net_data_orb <- Ofav_mix %>%
  select(Sample.Name, Symbiodinium, Breviolum, Cladocopium, Durusdinium)

edges_orb <- net_data_orb %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

depth_orb <- Ofav %>%
  select(Sample.Name, depth)

verts_orb <- tibble(Sample.Name = c(net_data_orb$Sample.Name, colnames(net_data_orb)[-1])) %>%
  left_join(depth_orb) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

net_orb <- graph_from_data_frame(edges_orb, directed = FALSE, vertices = verts_orb)

set.seed(7)

plot(net_orb, edge.curved = 0,
     edge.width = 2 * (E(net_orb)$weight)^0.4, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(net_orb)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(net_orb))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(net_orb))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(net_orb)$depth,breaks = 100))]))
```


#Network with distinct samples
```{r}

net_data_distinct <- distinct_combos %>%
  select(Sample.Name, Symbiodinium = A, Breviolum = B, Cladocopium = C, Durusdinium = D)

edges_distinct <- net_data_distinct %>%
  gather(key = "Genera", value = "weight", -Sample.Name) %>%
  filter(weight != 0) %>%
  mutate(weight = weight^(1))  # use exponent >1 to make rel. abund. matter more; <1 to matter less (i.e., pres/abs)

depth_distinct <- Ofav %>%
  filter(Sample.Name %in% distinct_combos$Sample.Name) %>%
  select(Sample.Name, depth)

depth_distinct$depth <- as.numeric(as.character(depth_distinct$depth))

verts_distinct <- tibble(Sample.Name = c(net_data_distinct$Sample.Name, colnames(net_data_distinct)[-1])) %>%
  left_join(depth_distinct) %>%
  rename(id = Sample.Name) %>%
  mutate(lab = case_when(grepl("EX", id) ~ "", grepl("um", id) ~ str_sub(id, start = 1, end = 1))) %>%
  select(id, depth, lab)

net_distinct <- graph_from_data_frame(edges_distinct, directed = FALSE, vertices = verts_distinct)

set.seed(15)

plot(net_distinct, edge.curved = 0,
     edge.width = 2 * (E(net_distinct)$weight)^0.07, 
     edge.color = "gray65",
     edge.curved = 1,
     vertex.label = V(net_distinct)$lab,
     vertex.label.font = 2,
     vertex.label.cex = 2.5,
     vertex.label.color = "black", 
     vertex.size = ifelse(grepl(".*um", names(V(net_distinct))), 20, 1),
     vertex.color = ifelse(grepl(".*um", names(V(net_distinct))), 
                           c('#a6cee3','#1f78b4','#b2df8a','#33a02c'),
                           colorRampPalette(c("white", "black"))(100)[as.numeric(cut(V(net_distinct)$depth,breaks = 100))]))

ggsave(filename = "distinct_sample_network.png", width = 300, height = 150, units = "mm")

ggsave(filename = "distinct_network.png", width = 300, height = 150, units = "mm")

```

```{r}
library(statnet)

set.seed(12345)

num_nodes <- 4

matrix <- matrix(round(runif(num_nodes*num_nodes)),
                 nrow = num_nodes, 
                 ncol = num_nodes)

diag(matrix) <- 0

net <- as.network(x = matrix, 
                  directed = FALSE, 
                  loops = FALSE, 
                  matrix.type = "adjacency")

network.vertex.names(net) <- LETTERS[1:4]

```






# Adjacency Matrix of Distinct Samples
```{r}
symbiont_pres <- distinct_combos %>%
  mutate(A = ifelse(A > 0, 1, 0),
         B = ifelse(B > 0, 1, 0),
         C = ifelse(C > 0, 1, 0),
         D = ifelse(D > 0, 1, 0)) %>%
  mutate(degree = A + B + C + D)



matrix <- symbiont_pres %>%
  mutate(AA = ifelse(A > 0 & B == 0 & C == 0 & D == 0, 1, 0),
         BB = ifelse(A == 0 & B > 0 & C == 0 & D == 0, 1, 0),
         CC = ifelse(A == 0 & B == 0 & C > 0 & D == 0, 1, 0),
         DD = ifelse(A == 0 & B == 0 & C == 0 & D > 0, 1, 0), 
         AB = ifelse(A > 0 & B > 0, 1, 0),
         AC = ifelse(A > 0 & C > 0, 1, 0),
         AD = ifelse(A > 0 & D > 0, 1, 0),
         BC = ifelse(B > 0 & C > 0, 1, 0),
         BD = ifelse(B > 0 & D > 0, 1, 0),
         CD = ifelse(C > 0 & D > 0, 1, 0)) %>%
   select(A = AA, B = BB, C = CC, D = DD, AB, AC, AD, BC, BD, CD)

colSums(matrix)


tribble(
  ~colA, ~colB, ~weight,
  "A", "B", 24,
  "A", "C", 19,
  "A", "D", 17,
  "B", "C", 33,
  "B", "D", 40,
  "C", "D", 37
)





as.matrix(matrix)



       
edges <- tribble(
  ~colA, ~colB, ~weight,
  "A", "B", 24,
  "A", "C", 19,
  "A", "D", 17,
  "B", "C", 33,
  "B", "D", 40,
  "C", "D", 37
)
nodes <- c("A", "B", "C", "D")

nn <- graph_from_data_frame(edges, directed = FALSE, vertices = nodes)
plot(nn, edge.width = E(nn)$weight^0.7)
                    
```

#Histogram of Coral Sample Degree 
```{r}
dom_sym <- Ofav %>%
  select(Sample.Name, dom_sym) %>%
  filter(Sample.Name %in% distinct_combos$Sample.Name)


hist <- symbiont_pres %>%
  right_join(dom_sym)

 ggplot(hist, aes(x = degree)) + 
   geom_histogram(binwidth = 0.9) +
   theme_bw()

 ggplot(hist, aes(x = degree)) + 
   geom_histogram(binwidth = 0.9) +
   facet_wrap(~dom_sym) +
   theme_bw()
  

```

# Proportinal Venn Diagram
```{r}
library(eulerr)


uniform_intersections <- euler(c("A" = 1, "B" = 43, "C" = 30,"D" = 104,
                                 "A&B" = 13, "A&C" = 3, "B&C" = 11, "B&D" = 9, "C&D" = 52, "A&B&C" = 5,
                                 "A&B&C&D" = 5, "A&B&D" = 4, "A&C&D" = 7, "B&C&D" = 14))
                            
plot(uniform_intersections)

```

#Tetrahedron Analysis
```{r}
library(compositions)
  
data(SimulatedAmounts)
dat <- rcomp(sa.lognormals)
dat

plot(dat)
```


```{r}
data(SimulatedAmounts)
dat <- rcomp(sa.groups5)
hc <- hclust(dist(dat), method = "complete")  # data are clustered 
kingTetrahedron(dat,parts=1:4, file="myfirst.kin", clu=cutree(hc,7),
scale=0.2)










x <- distinct_combos %>%
  select(A, B, C, D)

dataa <- rcomp(x)

bb <- kingTetrahedron(dataa, parts = 1:4, file = "myfirst.kin", clu = NULL, vec = NULL, )

plot(bb)


```







```{r}
Ofav_pa <- Ofav %>%
  select(Symbiodinium, Breviolum, Cladocopium, Durusdinium) %>%
  mutate_at(vars(Symbiodinium, Breviolum, Cladocopium, Durusdinium), 
            function(x) x > 0)

Ofav_pa

vennCounts(Ofav_pa)
vennDiagram(Ofav_pa)
```

```{r}
edges <- tribble(
  ~colA, ~colB, ~weight,
  "A", "B", 12,
  "A", "C", 7,
  "A", "D", 3,
  "B", "C", 11,
  "B", "D", 6,
  "C", "D", 6
)
nodes <- c("A", "B", "C", "D")

nn <- graph_from_data_frame(edges, directed = FALSE, vertices = nodes)
plot(nn, edge.width = E(nn)$weight)
```

